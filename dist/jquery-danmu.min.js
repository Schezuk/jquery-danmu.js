!function(a){"use strict";function b(b){this.conf=jQuery.extend({msgData:{},getMsgHtml:null,danMuJquery:a(".danMu"),lineNum:1,time:5e3},b||{}),this.lineObj=this.conf.danMuJquery.find('div[data-i="'+this.conf.lineNum+'"]'),this.msgObj=null,this.msgWidth=0,this.speed=7}function c(a){if(this.conf=jQuery.extend({danMuConf:null,getMsgHtml:null},a||{}),!this.conf.lineNum)throw new Error("lineNum is not allow empty!");this.danMuConf=this.conf.danMuConf||{},delete this.conf.danMuConf,this.lineObj=null,this.magList=[]}function d(b){this.conf=jQuery.extend({danMuJquery:a(".danMu"),minTime:5e3,maxTime:1e4,getMsgHtml:null},b||{}),this.lines=[]}var e=0,f=0;b.prototype={getHtml:function(){if(this.conf.getMsgHtml)return a(this.conf.getMsgHtml(this.conf.msgData));var b=[];return b.push('<div class="msg">'),b.push(this.conf.msgData.text),b.push("</div>"),a(b.join(""))},appendToHtml:function(){var a=this.getHtml();this.msgObj=a,a.css("transform","matrix(1, 0, 0, 1,"+e+", 0)"),this.lineObj.append(a),this.msgWidth=a.outerWidth(!0),this.speed=(e+this.msgWidth)/this.conf.time},init:function(){return this.appendToHtml(),this},play:function(){var a=this,b=this.conf.time,c="transform "+(b/1e3).toFixed(2)+"s linear";return a.msgObj.css({transition:c,"-moz-transition":c,"-webkit-transition":c,"-o-transition":c}).css("transform","matrix(1, 0, 0, 1, "+-a.msgWidth+", 0)"),{time:b,msgObj:a.msgObj}},stop:function(){return this.msgObj.css("transform",""),this}},c.prototype={checkLine:function(c){var d=this,f=!0,g=Math.random()*(d.danMuConf.maxTime-d.danMuConf.minTime)+d.danMuConf.minTime,h=new b({msgData:c,getMsgHtml:d.conf.getMsgHtml,danMuJquery:d.danMuConf.danMuJquery,time:g,lineNum:d.conf.lineNum}).init(),i=d.magList.length,j=null;if(i){j=d.magList[i-1];var k=j.msgObj.css("transform"),l=0;try{l=a.trim(k.split(",")[4])}catch(m){}var n=parseInt(l);if(e-n<j.msgWidth)f=!1;else{var o=(n+j.msgWidth)/j.speed,p=h.speed*o;p>e&&(f=!1)}}if(f){var q=h.play();return setTimeout(function(){q.msgObj.fadeOut(300,function(){q.msgObj.remove(),d.magList.shift()})},q.time+2e3),d.magList.push(h),h}return h.msgObj.remove(),null},getMaxLineNum:function(){var b=0;return a("div[data-i]").each(function(c,d){var e=parseInt(a(d).attr("data-i"));e>b&&(b=e)}),b},getHtml:function(){var b=[];return b.push('<div class="line" data-i="'),b.push(this.conf.lineNum),b.push('"></div>'),a(b.join(""))},appendToHtml:function(){var a=this.getHtml();this.danMuConf.danMuJquery.append(a),this.lineObj=a},init:function(){return this.appendToHtml(),this}},d.prototype={init:function(){var b=this,d=b.conf.danMuJquery.height(),e=function(a){var d=new c({lineNum:a+1,danMuConf:b.conf,getMsgHtml:b.conf.getMsgHtml});return d.init(),b.lines.push(d),d};e(0);for(var f=b.conf.lineHeight||a(".line").outerHeight(!0),g=b.conf.lineCount||parseInt(d/f),h=1;g>h;h++)e(h);return b},push:function(a,b){if(!a)return void(b&&b(a));var c=this,d=function(a){var e=parseInt(Math.random()*c.lines.length),f=c.lines[e].checkLine(a);f?b&&b(a):setTimeout(function(){d(a)},500)};return d(a),this}},a.fn.danMu=function(b){var c=a(this);e=c.outerWidth(!0),f=c.outerHeight(!0),b=a.extend({danMuJquery:c},b||{});var g=new d(b);return g}}(jQuery);