!function(a){"use strict";function b(b){this.conf=jQuery.extend({msgData:{},getMsgHtml:null,danMuJquery:a(".danMu"),lineNum:1,time:5e3},b||{}),this.lineObj=this.conf.danMuJquery.find('div[data-i="'+this.conf.lineNum+'"]'),this.msgObj=null,this.msgWidth=0,this.speed=7}function c(a){if(this.conf=jQuery.extend({danMuConf:null,getMsgHtml:null},a||{}),!this.conf.lineNum)throw new Error("lineNum is not allow empty!");this.danMuConf=this.conf.danMuConf||{},delete this.conf.danMuConf,this.lineObj=null,this.magList=[]}function d(b){this.conf=jQuery.extend({danMuJquery:a(".danMu"),minTime:5e3,maxTime:1e4,getMsgHtml:null},b||{}),this.lines=[]}var e=0,f=0;b.prototype={getHtml:function(){if(this.conf.getMsgHtml)return a(this.conf.getMsgHtml(this.conf.msgData));var b=[];return b.push('<div class="msg">'),b.push(this.conf.msgData.text),b.push("</div>"),a(b.join(""))},appendToHtml:function(){var a=this.getHtml();this.msgObj=a,a.css("transform","matrix(1, 0, 0, 1,"+e+", 0)"),this.lineObj.append(a),this.msgWidth=a.outerWidth(!0),this.speed=(e+this.msgWidth)/this.conf.time},init:function(){return this.appendToHtml(),this},play:function(){var a=this,b=this.conf.time,c="transform "+(b/1e3).toFixed(2)+"s linear";return a.msgObj.css({transition:c,"-moz-transition":c,"-webkit-transition":c,"-o-transition":c}).css("transform","matrix(1, 0, 0, 1, "+-a.msgWidth+", 0)"),{time:b,msgObj:a.msgObj}},stop:function(){return this.msgObj.css("transform",""),this}},c.prototype={checkLine:function(c,d,f){var g=this,h=!0,i=Math.random()*(g.danMuConf.maxTime-g.danMuConf.minTime)+g.danMuConf.minTime,j=new b({msgData:c,getMsgHtml:g.conf.getMsgHtml,danMuJquery:g.danMuConf.danMuJquery,time:i,lineNum:g.conf.lineNum}).init(),k=g.magList.length,l=null;if(k){l=g.magList[k-1];var m=l.msgObj.css("transform"),n=0;try{n=a.trim(m.split(",")[4])}catch(o){}var p=parseInt(n);if(e-p<l.msgWidth)h=!1;else{var q=(p+l.msgWidth)/l.speed,r=j.speed*q;r>e&&(h=!1)}}if(h){var s=j.play();return setTimeout(function(){s.msgObj.fadeOut(300,function(){s.msgObj.remove(),g.magList.shift(),f&&f(c)})},s.time+1e3),g.magList.push(j),d&&d(c),j}return j.msgObj.remove(),null},getMaxLineNum:function(){var b=0;return a("div[data-i]").each(function(c,d){var e=parseInt(a(d).attr("data-i"));e>b&&(b=e)}),b},getHtml:function(){var b=[];return b.push('<div class="line" data-i="'),b.push(this.conf.lineNum),b.push('"></div>'),a(b.join(""))},appendToHtml:function(){var a=this.getHtml();this.danMuConf.danMuJquery.append(a),this.lineObj=a},init:function(){return this.appendToHtml(),this}},d.prototype={init:function(){var b=this,d=b.conf.danMuJquery.height(),e=function(a){var d=new c({lineNum:a+1,danMuConf:b.conf,getMsgHtml:b.conf.getMsgHtml});return d.init(),b.lines.push(d),d};e(0);for(var f=b.conf.lineHeight||a(".line").outerHeight(!0),g=b.conf.lineCount||parseInt(d/f),h=1;g>h;h++)e(h);return b},push:function(a,b,c){if(!a)return b&&b(a),void(c&&c(a));var d=this,e=function(a){var f=parseInt(Math.random()*d.lines.length),g=d.lines[f].checkLine(a,b,c);g||setTimeout(function(){e(a)},500)};return e(a),this}},a.fn.danMu=function(b){var c=a(this);e=c.outerWidth(!0),f=c.outerHeight(!0),b=a.extend({danMuJquery:c},b||{});var g=new d(b);return g}}(jQuery);